<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Vapor Documentation</title>

        <link rel="stylesheet"  href="https://fonts.googleapis.com/css?family=Source+Code+Pro">
        <link rel="stylesheet"  href="https://fonts.googleapis.com/css?family=Quicksand:400,700,300">
        <link rel="stylesheet" href="https://vapor.github.io/documentation/styles/vapor-code.css">
        <link rel="stylesheet" href="https://vapor.github.io/documentation/styles/main.css">
    </head>
    <body>

        <header>
            <a class="logo" href="https://vapor.github.io/documentation/">
                <img src="https://vapor.github.io/documentation/images/droplet.svg" alt="Vapor">
                <h1>Vapor <em>Docs</em></h1>
            </a>
            <ul>
                <li>
                    <a href="http://vapor.codes">Home</a>
                </li>
                <li>
                    <a href="http://example.vapor.codes">Example</a>
                </li>
                <li>
                    <a href="https://github.com/vapor/vapor">GitHub</a>
                </li>
                <li>
                    <a href="https://twitter.com/@codevapor">Twitter</a>
                </li>
                <li>
                    <a href="http://vapor.team">Slack</a>
                </li>
            </ul>
        </header>

        <nav>
            <div class="scroll">
                            <section>
                    <h3>Getting Started</h3>
                    <ul>
                                            <li class="">
                            <a href="https://vapor.github.io/documentation/getting-started/install-swift-3-macos.html">
                                Install Swift 3: macOS
                            </a>
                        </li>
                                            <li class="">
                            <a href="https://vapor.github.io/documentation/getting-started/install-swift-3-ubuntu.html">
                                Install Swift 3: Ubuntu
                            </a>
                        </li>
                                            <li class="">
                            <a href="https://vapor.github.io/documentation/getting-started/install-swift-3.html">
                                Install Swift 3
                            </a>
                        </li>
                                            <li class="">
                            <a href="https://vapor.github.io/documentation/getting-started/install-toolbox.html">
                                Install Toolbox
                            </a>
                        </li>
                                            <li class="">
                            <a href="https://vapor.github.io/documentation/getting-started/manual.html">
                                Manual
                            </a>
                        </li>
                                            <li class="">
                            <a href="https://vapor.github.io/documentation/getting-started/hello-world.html">
                                Hello, World
                            </a>
                        </li>
                                            <li class="">
                            <a href="https://vapor.github.io/documentation/getting-started/xcode.html">
                                Xcode
                            </a>
                        </li>
                                        </ul>
                </section>
                            <section>
                    <h3>Guide</h3>
                    <ul>
                                            <li class="">
                            <a href="https://vapor.github.io/documentation/guide/droplet.html">
                                Droplet
                            </a>
                        </li>
                                            <li class="">
                            <a href="https://vapor.github.io/documentation/guide/folder-structure.html">
                                Folder Structure
                            </a>
                        </li>
                                            <li class="">
                            <a href="https://vapor.github.io/documentation/guide/json.html">
                                JSON
                            </a>
                        </li>
                                            <li class="">
                            <a href="https://vapor.github.io/documentation/guide/config.html">
                                Config
                            </a>
                        </li>
                                            <li class="">
                            <a href="https://vapor.github.io/documentation/guide/views.html">
                                Views
                            </a>
                        </li>
                                            <li class="active">
                            <a href="https://vapor.github.io/documentation/guide/middleware.html">
                                Middleware
                            </a>
                        </li>
                                            <li class="">
                            <a href="https://vapor.github.io/documentation/guide/validation.html">
                                Validation
                            </a>
                        </li>
                                            <li class="">
                            <a href="https://vapor.github.io/documentation/guide/provider.html">
                                Provider
                            </a>
                        </li>
                                            <li class="">
                            <a href="https://vapor.github.io/documentation/guide/hash.html">
                                Hash
                            </a>
                        </li>
                                        </ul>
                </section>
                            <section>
                    <h3>Routing</h3>
                    <ul>
                                            <li class="">
                            <a href="https://vapor.github.io/documentation/routing/basic.html">
                                Basic
                            </a>
                        </li>
                                            <li class="">
                            <a href="https://vapor.github.io/documentation/routing/parameters.html">
                                Parameters
                            </a>
                        </li>
                                            <li class="">
                            <a href="https://vapor.github.io/documentation/routing/group.html">
                                Group
                            </a>
                        </li>
                                            <li class="">
                            <a href="https://vapor.github.io/documentation/routing/collection.html">
                                Collection
                            </a>
                        </li>
                                        </ul>
                </section>
                            <section>
                    <h3>Fluent</h3>
                    <ul>
                                            <li class="">
                            <a href="https://vapor.github.io/documentation/fluent/driver.html">
                                Driver
                            </a>
                        </li>
                                            <li class="">
                            <a href="https://vapor.github.io/documentation/fluent/model.html">
                                Model
                            </a>
                        </li>
                                            <li class="">
                            <a href="https://vapor.github.io/documentation/fluent/query.html">
                                Query
                            </a>
                        </li>
                                            <li class="">
                            <a href="https://vapor.github.io/documentation/fluent/relation.html">
                                Relation
                            </a>
                        </li>
                                        </ul>
                </section>
                            <section>
                    <h3>HTTP</h3>
                    <ul>
                                            <li class="">
                            <a href="https://vapor.github.io/documentation/http/request.html">
                                Request
                            </a>
                        </li>
                                            <li class="">
                            <a href="https://vapor.github.io/documentation/http/response.html">
                                Response
                            </a>
                        </li>
                                            <li class="">
                            <a href="https://vapor.github.io/documentation/http/body.html">
                                Body
                            </a>
                        </li>
                                            <li class="">
                            <a href="https://vapor.github.io/documentation/http/response-representable.html">
                                ResponseRepresentable
                            </a>
                        </li>
                                            <li class="">
                            <a href="https://vapor.github.io/documentation/http/responder.html">
                                Responder
                            </a>
                        </li>
                                            <li class="">
                            <a href="https://vapor.github.io/documentation/http/client.html">
                                Client
                            </a>
                        </li>
                                        </ul>
                </section>
                        </div>
        </nav>

        <main>
            <a href="https://github.com/vapor/documentation/blob/master/CONTRIBUTING.md" class="edit">✎ Edit on GitHub</a>
            <h1 id="middleware">Middleware</h1>
<p>Middleware is an essential part of any modern web framework. It allows you to modify requests and responses as they pass between the client and your server.</p>
<p>You can imagine middleware as a chain of logic connection your server to the client requesting your web app.</p>
<h2 id="basic">Basic</h2>
<p>As an example, let's create a middleware that will add the version of our API to each response. The middleware would look something like this:</p>
<pre><code class="language-swift">final class VersionMiddleware: Middleware {
    func respond(to request: Request, chainingTo next: Responder) throws -&gt; Response {
        let response = try next.respond(to: request)

        response.headers["Version"] = "API v1.0"

        return response
    }
}</code></pre>
<p>We then add this middleware to our <code>Droplet</code>.</p>
<pre><code class="language-swift">drop.middleware.append(VersionMiddleware())</code></pre>
<p>You can imagine our <code>VersionMiddleware</code> sitting in the middle of a chain that connects the client and our server. Every request and response that hits our server must go through this chain of middleware.</p>
<p><img src="https://cloud.githubusercontent.com/assets/1342803/17382676/0b51d6d6-59a0-11e6-9cbb-7585b9ab9803.png" alt="Middleware" /></p>
<h2 id="breakdown">Breakdown</h2>
<p>Let's break down the middleware line by line.</p>
<pre><code class="language-swift">let response = try next.respond(to: request)</code></pre>
<p>Since the <code>VersionMiddleware</code> in this example is not interested in modifying the request, we immediately ask the next middleware in the chain to respond to the request. This goes all the way down the chain to the <code>Droplet</code> and comes back with the response that should be sent to the client.</p>
<pre><code class="language-swift">response.headers["Version"] = "API v1.0"</code></pre>
<p>We then <em>modify</em> the response to contain a Version header.</p>
<pre><code class="language-swift">return response</code></pre>
<p>The response is returned and will chain back up any remaining middleware and back to the client.</p>
<h2 id="request">Request</h2>
<p>The middleware can also modify or intereact with the request.</p>
<pre><code class="language-swift">func respond(to request: Request, chainingTo next: Responder) throws -&gt; Response {
    guard request.cookies["token"] == "secret" else {
        throw Abort.badRequest
    }

    return try next.respond(to: request)
}</code></pre>
<p>This middleware will require that the request has a cookie named <code>token</code> that equals <code>secret</code> or else the request will be aborted.</p>
<h2 id="errors">Errors</h2>
<p>Middleware is the perfect place to catch errors thrown from anywhere in your application. When you let the middleware catch errors, you can remove a lot of duplicated logic from your route closures. Take a look at the following example:</p>
<pre><code class="language-swift">enum FooError: Error {
    case fooServiceUnavailable
}</code></pre>
<p>Say there is a custom error that either you defined or one of the APIs you are using <code>throw</code>s. This error must be caught when thrown, or else it will end up as a server error which may be unexpected to a user. The most obvious solution is to catch the error in the route closure.</p>
<pre><code class="language-swift">app.get("foo") { request in
    let foo: Foo
    do {
        foo = try getFooFromService()
    } catch {
        throw Abort.badRequest
    }

    // continue with Foo object
}</code></pre>
<p>This solution works, but it would get repetative if repeated throughout multiple routes. It can also easily lead to code duplication. Luckily, this error could be caught in a middleware instead.</p>
<pre><code class="language-swift">final class FooErrorMiddleware: Middleware {
    func respond(to request: Request, chainingTo next: Responder) throws -&gt; Response {
        do {
            return try next.respond(to: request)
        } catch FooError.fooServiceUnavailable {
            throw Abort.custom(
                status: .badRequest,
                message: "Sorry, we were unable to query the Foo service."
            )
        }
    }
}</code></pre>
<p>We just need to append this middleware to the <code>Droplet</code>.</p>
<pre><code class="language-swift">drop.middleware.append(FooErrorMiddleware())</code></pre>
<p>Now our route closures look a lot better and we don't have to worry about code duplication.</p>
<pre><code class="language-swift">app.get("foo") { request in
    let foo = try getFooFromService()

    // continue with Foo object
}</code></pre>
<p>Interestingly, this is how <code>Abort</code> itself is implemented in Vapor. <code>AbortMiddleware</code> catches any <code>Abort</code> errors and returns a JSON response. Should you want to customize how <code>Abort</code> errors appear, you can remove this middleware and add your own.</p>
<h2 id="extensions-advanced">Extensions (Advanced)</h2>
<p>Middleware pairs great with request/response extensions and storage.</p>
<pre><code class="language-swift">final class PokemonMiddleware: Middleware {
    let drop: Droplet
    init(drop: Droplet) {
        self.drop = dropt
    }

    func respond(to request: Request, chainingTo next: Responder) throws -&gt; Response {
        let response = try next.respond(to: request)

        if let pokemon = response.pokemon {
            request.accept.prefers("html") {
                response.view = try drop.view("pokemon.mustache", context: pokemon)
            } else {
                response.json = try pokemon.makeJSON()
            }
        }

        return response
    }
}</code></pre>
<p>And the extension to <code>Response</code>.</p>
<pre><code class="language-swift">extension Response {
    var pokemon: Pokemon? {
        get { return storage["pokemon"] as? Pokemon }
        set { storage["pokemon"] = newValue }
    }
}</code></pre>
<p>In this example, we added a new property to response capable of holding a Pokémon object. If the middleware finds a response with one of these Pokémon objects, it will dynamically check whether the client prefers HTML. If the client is a browser like Safari and prefers HTML, it will return a Mustache view. If the client does not prefer HTML, it will return JSON.</p>
<p>Your closures can now look something like this:</p>
<pre><code class="language-swift">import HTTP

drop.get("pokemon", Pokemon.self) { request, pokemon in
    let response = Response()
    response.pokemon = pokemon
    return response
}</code></pre>
<p>Or, if you want to go a step further, you can make <code>Pokemon</code> conform to <code>ResponseRepresentable</code>.</p>
<pre><code class="language-swift">import HTTP

extension Pokemon: ResponseRepresentable {
    func makeResponse() throws -&gt; Response {
        let response = Response()
        response.pokemon = self
        return response
    }
}</code></pre>
<p>Now your route closures are greatly simplified and you don't need to <code>import HTTP</code>.</p>
<pre><code class="language-swift">drop.get("pokemon", Pokemon.self) { request, pokemon in
    return pokemon
}</code></pre>
<p>Middleware is incredibly powerful. Combined with extensions, it allows you to add functionality that feels native to the framework.</p>
<p>For those that are curious, this is how Vapor manages JSON internally. Whenever you return JSON in a closure, it sets the <code>json: JSON?</code> property on <code>Response</code>. The <code>JSONMiddleware</code> then detects this property and serializes the JSON into the body of the response.</p>
        </main>

        <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
        <script src="https://vapor.github.io/documentation/scripts/highlight.pack.js"></script>

        <script>
            $(function() {
                // Syntax highlighting
                hljs.initHighlightingOnLoad();

                if (navigator.userAgent.indexOf('Safari') != -1 && navigator.userAgent.indexOf('Chrome') == -1) {
                    $('body').addClass('safari');
                }
            });
        </script>

    </body>
</html>
